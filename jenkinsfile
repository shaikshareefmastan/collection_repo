pipeline {
   agent { label 'kopserver'
}
    parameters {
                 booleanParam(defaultValue: false, description: '', name: 'collection')
                 booleanParam(defaultValue: false, description: '', name: 'collection1')
            }
   stages {
      stage('git checkout') {
         steps {
            git 'https://github.com/shaikshareefmastan/apipro.git'
         }
       }
         stage('test'){
                steps{
                 script{
                              def var = awk '{ print $4 }'
                              def var1 =  sed -n '2 p' 
                              sh 'kubectl get service -l app=apiservice | ${var} | ${var1}  > /tmp/aa'
                                           def VAR1 = readFile('/tmp/aa')
			}
				}
  
}
      	stage('Build collection') {
                        
            when {
                         expression { params.collection }
                     }
         steps {
	            sh "kubectl cp collection.json api-pod:/etc/newman "
                    sh "kubectl exec api-pod -- newman run collection.json -r htmlextra --reporter-htmlextra-export /var/www/html/collection.html"
                     sh "echo http://${VAR1}/collection.html"

                    
                }
               }
      stage('Build collection1'){
                  when { 
                                  expression { params.collection1 }
                             }
           steps {
                     
                    sh "kubectl cp collection1.json api-pod:/etc/newman "
                    sh "kubectl exec api-pod -- newman run collection1.json -r htmlextra --reporter-htmlextra-export /var/www/html/collection1.html"
                    sh "echo http://${VAR1}/collection1.html"
               }
           
     }
   }
}
